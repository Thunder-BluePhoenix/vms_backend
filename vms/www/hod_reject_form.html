<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart Rejection - HOD Approval</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 40px;
      color: white;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    h1 {
      color: #2d3748;
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #718096;
      font-size: 16px;
    }

    .cart-info {
      background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
      border-left: 4px solid #667eea;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .cart-info-label {
      color: #4a5568;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .cart-info-value {
      color: #2d3748;
      font-size: 20px;
      font-weight: 700;
      font-family: 'Courier New', monospace;
    }

    .form-group {
      margin-bottom: 25px;
    }

    label {
      display: block;
      color: #2d3748;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .required {
      color: #f5576c;
      margin-left: 4px;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      resize: vertical;
      transition: all 0.3s ease;
      background: #f7fafc;
    }

    textarea:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    textarea::placeholder {
      color: #a0aec0;
    }

    .char-count {
      text-align: right;
      color: #718096;
      font-size: 13px;
      margin-top: 5px;
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    button {
      flex: 1;
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-submit {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3);
    }

    .btn-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
    }

    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-cancel {
      background: #e2e8f0;
      color: #4a5568;
    }

    .btn-cancel:hover {
      background: #cbd5e0;
      transform: translateY(-2px);
    }

    .spinner {
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.8s linear infinite;
      display: none;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 500;
      display: none;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease-out;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
      display: flex;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
      display: flex;
    }

    .message-icon {
      font-size: 20px;
    }

    @media (max-width: 600px) {
      .container {
        padding: 30px 20px;
      }

      h1 {
        font-size: 24px;
      }

      .button-group {
        flex-direction: column;
      }

      button {
        width: 100%;
      }
    }
  </style>
  <!-- Include Frappe's CSRF token handling -->
  <script src="/assets/frappe/js/lib/jquery/jquery.min.js"></script>
  <script>
    // Get CSRF token from cookies
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Set CSRF token for all requests
    window.csrf_token = getCookie('csrf_token');
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="icon">⚠️</div>
      <h1>Cart Rejection</h1>
      <p class="subtitle">Please provide a reason for rejecting this cart</p>
    </div>

    <div class="cart-info">
      <div class="cart-info-label">Cart ID</div>
      <div class="cart-info-value" id="cart_id">Loading...</div>
    </div>

    <form id="rejectionForm" onsubmit="submitRejection(event)">
      <div class="form-group">
        <label for="reason">
          Reason for Rejection<span class="required">*</span>
        </label>
        <textarea
          id="reason"
          name="reason"
          placeholder="Please provide detailed reasons for rejecting this cart. Include any specific concerns or issues that need to be addressed..."
          maxlength="1000"
          required
          oninput="updateCharCount()"
        ></textarea>
        <div class="char-count">
          <span id="charCount">0</span> / 1000 characters
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn-cancel" onclick="handleCancel()">
          ✕ Cancel
        </button>
        <button type="submit" class="btn-submit" id="submitBtn">
          <span class="spinner" id="spinner"></span>
          <span id="btnText">✓ Submit Rejection</span>
        </button>
      </div>
    </form>

    <div id="message" class="message">
      <span class="message-icon" id="messageIcon"></span>
      <span id="messageText"></span>
    </div>
  </div>

  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const cart_id = urlParams.get('cart_id');
    const user = urlParams.get('user');
    const hod_email = urlParams.get('hod_email');

    // Display cart ID
    if (cart_id) {
      document.getElementById('cart_id').textContent = cart_id;
    } else {
      document.getElementById('cart_id').textContent = 'Invalid Cart ID';
      showMessage('error', 'Invalid cart ID in URL');
      document.getElementById('submitBtn').disabled = true;
    }

    // Validate hod_email
    if (!hod_email) {
      showMessage('error', 'Invalid authorization parameters');
      document.getElementById('submitBtn').disabled = true;
    }

    // Update character count
    function updateCharCount() {
      const textarea = document.getElementById('reason');
      const count = textarea.value.length;
      document.getElementById('charCount').textContent = count;
    }

    // Show message
    function showMessage(type, text) {
      const messageDiv = document.getElementById('message');
      const messageIcon = document.getElementById('messageIcon');
      const messageText = document.getElementById('messageText');

      messageDiv.className = 'message ' + type;
      messageIcon.textContent = type === 'success' ? '✓' : '✕';
      messageText.textContent = text;
      messageDiv.style.display = 'flex';
    }

    // Hide message
    function hideMessage() {
      document.getElementById('message').style.display = 'none';
    }

    // Handle form submission
    async function submitRejection(event) {
      event.preventDefault();
      hideMessage();

      const reason = document.getElementById('reason').value.trim();
      const submitBtn = document.getElementById('submitBtn');
      const spinner = document.getElementById('spinner');
      const btnText = document.getElementById('btnText');

      if (!reason) {
        showMessage('error', 'Please enter a reason for rejection');
        return;
      }

      if (!cart_id || !user || !hod_email) {
        showMessage('error', 'Missing required parameters');
        return;
      }

      // Show loading state
      submitBtn.disabled = true;
      spinner.style.display = 'block';
      btnText.textContent = 'Submitting...';

      try {
        // Prepare form data
        const formData = new FormData();
        formData.append("cart_id", cart_id);
        formData.append("user", user);
        formData.append("hod_email", hod_email);
        formData.append("action", "reject");
        formData.append("rejection_reason", reason);

        // Include CSRF token in headers
        const headers = {};
        if (window.csrf_token) {
          headers['X-Frappe-CSRF-Token'] = window.csrf_token;
        }

        // Make API request
        const response = await fetch(
          `/api/method/vms.material.doctype.cart_details.cart_details.hod_approval_check`,
          {
            method: "POST",
            headers: headers,
            body: formData
          }
        );

        const result = await response.json();

        // Reset button state
        submitBtn.disabled = false;
        spinner.style.display = 'none';
        btnText.textContent = '✓ Submit Rejection';

        // Handle response based on status
        if (result.status === 'success') {
          const successMsg = typeof result.message === 'string'
            ? result.message
            : 'Cart rejection submitted successfully!';
          showMessage('success', successMsg);

          // Disable form after successful submission
          document.getElementById('reason').disabled = true;
          submitBtn.disabled = true;

          // Close window after delay
          setTimeout(() => {
            window.close();
            // If window.close() doesn't work (popup blocker), show message
            if (!window.closed) {
              showMessage('success', 'You can now close this window');
            }
          }, 2000);
        } else if (result.status === 'already_processed') {
          // Cart was already processed
          const alreadyMsg = typeof result.message === 'string'
            ? result.message
            : 'This cart has already been processed';
          showMessage('error', alreadyMsg);
          document.getElementById('reason').disabled = true;
          submitBtn.disabled = true;
        } else {
          // Error occurred - handle all possible error formats
          let errorMsg = 'Failed to submit rejection';

          // Try to extract error message from various possible formats
          if (result.message) {
            if (typeof result.message === 'string') {
              errorMsg = result.message;
            } else if (typeof result.message === 'object') {
              // Handle message as object
              errorMsg = JSON.stringify(result.message);
            }
          }

          // Handle _server_messages format (Frappe specific)
          if (result._server_messages) {
            try {
              const serverMsgs = JSON.parse(result._server_messages);
              if (Array.isArray(serverMsgs) && serverMsgs.length > 0) {
                const firstMsg = JSON.parse(serverMsgs[0]);
                if (firstMsg.message) {
                  errorMsg = firstMsg.message;
                }
              }
            } catch (e) {
              console.error('Error parsing server messages:', e);
            }
          }

          // Handle exception format
          if (result.exception) {
            try {
              // Try to extract meaningful error from exception string
              const excMatch = result.exception.match(/"message":\s*"([^"]+)"/);
              if (excMatch && excMatch[1]) {
                errorMsg = excMatch[1];
              } else if (typeof result.exception === 'string') {
                // Check if exception contains "Invalid Request" or other errors
                if (result.exception.includes('CSRFTokenError')) {
                  errorMsg = 'Invalid Request - Please refresh the page and try again';
                } else if (result.exception.includes('PermissionError')) {
                  errorMsg = 'Permission denied - You may not have access to perform this action';
                }
              }
            } catch (e) {
              console.error('Error parsing exception:', e);
            }
          }

          // Handle exc_type (Frappe error type)
          if (result.exc_type) {
            if (result.exc_type === 'CSRFTokenError') {
              errorMsg = 'Session expired - Please refresh the page and try again';
            } else if (result.exc_type === 'PermissionError') {
              errorMsg = 'Permission denied - You may not have access to perform this action';
            }
          }

          showMessage('error', errorMsg);
        }

      } catch (error) {
        console.error("Error:", error);
        submitBtn.disabled = false;
        spinner.style.display = 'none';
        btnText.textContent = '✓ Submit Rejection';
        showMessage('error', 'Failed to connect to the server. Please try again.');
      }
    }

    // Handle cancel
    function handleCancel() {
      if (confirm('Are you sure you want to cancel? Your entered reason will be lost.')) {
        window.close();
        // If window.close() doesn't work, redirect to home
        if (!window.closed) {
          window.location.href = '/';
        }
      }
    }

    // Prevent accidental navigation
    window.addEventListener('beforeunload', function (e) {
      const reason = document.getElementById('reason').value.trim();
      const submitBtn = document.getElementById('submitBtn');

      if (reason && !submitBtn.disabled) {
        e.preventDefault();
        e.returnValue = '';
      }
    });
  </script>
</body>
</html>

